<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>单机密码管家</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="安全、单机的跨平台密码管理器">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json;base64,ewogICJuYW1lIjogIuWNleacuuWvhueggeeuoeeQhuWZqCIsCiAgInNob3J0X25hbWUiOiAi5a+u56CB566h5a62IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciIjogIiMwZjE3MmEiLAogICJpY29ucyI6IFtdCn0='>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        input, textarea { font-size: 16px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- 图标组件 (内嵌 SVG，解决网络加载问题) ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Lock = (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Unlock = (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (p) => <IconBase {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.09"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Key = (p) => <IconBase {...p}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.9 5.8a2 2 0 0 1-1.2 1.3l-5.9 1.8 5.9 1.8a2 2 0 0 1 1.2 1.3l1.9 5.9 1.9-5.9a2 2 0 0 1 1.2-1.3l5.9-1.8-5.9-1.8a2 2 0 0 1-1.2-1.3l-1.9-5.9Z"/></IconBase>;
        const Bot = (p) => <IconBase {...p}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></IconBase>;
        const UserPlus = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconBase>;
        const ArrowLeft = (p) => <IconBase {...p}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const Send = (p) => <IconBase {...p}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;


        // --- Gemini API 集成 ---
        const apiKey = ""; // 运行时会自动注入 API Key (注意：作为本地HTML文件运行时，你需要手动填入 Key 才能使用AI功能)

        const callGemini = async (prompt, systemInstruction = "") => {
            if (!apiKey) return "请在代码中配置 API Key 以使用 AI 功能。";
            try {
                const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                    }),
                }
                );
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "无法生成响应";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "AI 服务暂时不可用，请稍后再试。";
            }
        };

        // --- 加密/解密 工具函数 ---
        const DB_NAME = 'secure_pass_manager_v1';
        const str2ab = (str) => new TextEncoder().encode(str);
        const ab2str = (buf) => {
            const bytes = new Uint8Array(buf);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
        };
        const str2buf = (str) => {
            const binaryString = atob(str);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        };
        const deriveKey = async (password, salt) => {
            const keyMaterial = await window.crypto.subtle.importKey("raw", str2ab(password), { name: "PBKDF2" }, false, ["deriveKey"]);
            return window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
            );
        };
        const encryptData = async (data, password) => {
            try {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const key = await deriveKey(password, salt);
                const content = JSON.stringify(data);
                const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, str2ab(content));
                return JSON.stringify({ salt: ab2str(salt), iv: ab2str(iv), content: ab2str(encrypted) });
            } catch (e) { console.error(e); throw new Error("加密失败"); }
        };
        const decryptData = async (encryptedJson, password) => {
            try {
                const parsed = JSON.parse(encryptedJson);
                const salt = str2buf(parsed.salt);
                const iv = str2buf(parsed.iv);
                const encryptedContent = str2buf(parsed.content);
                const key = await deriveKey(password, salt);
                const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, encryptedContent);
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (e) {
                if (e.name === 'OperationError') throw new Error("密码错误");
                throw new Error("数据损坏或解密失败");
            }
        };

        // --- 组件逻辑 ---
        
        function AITools({ onBack, showNotification }) {
            const [activeTab, setActiveTab] = useState('menu');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState('');
            const [chatMessages, setChatMessages] = useState([{ role: 'ai', text: '你好！我是你的安全顾问。关于网络安全、密码管理或二步验证的问题，尽管问我。' }]);
            const [chatInput, setChatInput] = useState('');
            const chatEndRef = useRef(null);

            useEffect(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), [chatMessages]);

            const handleGeneratePassphrase = async () => {
                setLoading(true);
                const res = await callGemini("生成 5 个高强度但易于记忆的密码短语。使用 4 个随机单词组合，用连字符连接。仅返回密码列表，每行一个。");
                setResult(res); setLoading(false);
            };

            const handleGenerateFakeID = async () => {
                setLoading(true);
                const res = await callGemini("生成一个逼真的虚拟身份用于注册网站，包含：全名（中文）、虚构的中国地址、虚构的手机号、用户名和生日。");
                setResult(res); setLoading(false);
            };

            const handleChatSend = async () => {
                if (!chatInput.trim()) return;
                const userMsg = chatInput;
                setChatMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setChatInput(''); setLoading(true);
                const aiRes = await callGemini(`用户问题: ${userMsg}`, "你是一个网络安全专家助手。");
                setChatMessages(prev => [...prev, { role: 'ai', text: aiRes }]);
                setLoading(false);
            };

            if (activeTab === 'menu') {
                return (
                    <div className="space-y-4">
                        <div className="bg-gradient-to-r from-purple-900 to-indigo-900 rounded-xl p-6 text-white mb-6">
                            <div className="flex items-center gap-3 mb-2"><Sparkles className="text-yellow-300" size={24} /><h2 className="text-xl font-bold">AI 智能工具箱</h2></div>
                            <p className="text-indigo-200 text-sm">由 Google Gemini 提供支持。</p>
                        </div>
                        <div className="grid gap-4">
                            <button onClick={() => { setActiveTab('passphrase'); handleGeneratePassphrase(); }} className="flex items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div className="p-3 bg-green-900 rounded-lg text-green-400"><Key size={24} /></div>
                                <div className="text-left"><div className="font-semibold">易记密码生成器</div></div>
                            </button>
                            <button onClick={() => { setActiveTab('fakeid'); handleGenerateFakeID(); }} className="flex items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div className="p-3 bg-blue-900 rounded-lg text-blue-400"><UserPlus size={24} /></div>
                                <div className="text-left"><div className="font-semibold">虚拟身份生成器</div></div>
                            </button>
                            <button onClick={() => setActiveTab('chat')} className="flex items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div className="p-3 bg-purple-900 rounded-lg text-purple-400"><Bot size={24} /></div>
                                <div className="text-left"><div className="font-semibold">安全顾问聊天</div></div>
                            </button>
                        </div>
                    </div>
                );
            }
            if (activeTab === 'chat') {
                return (
                    <div className="flex flex-col h-[calc(100vh-140px)]">
                        <div className="flex items-center gap-2 mb-4 shrink-0"><button onClick={() => setActiveTab('menu')} className="p-2 bg-slate-800 rounded-full"><ArrowLeft size={20} /></button><h3 className="font-bold">安全顾问</h3></div>
                        <div className="flex-1 bg-slate-900 rounded-xl border border-slate-800 p-4 overflow-y-auto space-y-4 mb-4">
                            {chatMessages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] rounded-2xl p-3 text-sm ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-800 border border-slate-700'}`}>{msg.text}</div>
                                </div>
                            ))}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="flex gap-2 shrink-0">
                            <input value={chatInput} onChange={e => setChatInput(e.target.value)} className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3" placeholder="输入问题..." />
                            <button onClick={handleChatSend} disabled={loading} className="bg-blue-600 text-white p-3 rounded-xl"><Send size={20} /></button>
                        </div>
                    </div>
                );
            }
            return (
                <div className="flex flex-col h-[calc(100vh-140px)]">
                    <div className="flex items-center gap-2 mb-4"><button onClick={() => setActiveTab('menu')} className="p-2 bg-slate-800 rounded-full"><ArrowLeft size={20} /></button><h3 className="font-bold">生成结果</h3></div>
                    <div className="flex-1 bg-slate-900 rounded-xl border border-slate-800 p-4 overflow-y-auto whitespace-pre-wrap font-mono text-sm">{loading ? "生成中..." : result}</div>
                    <div className="mt-4 flex gap-3">
                         <button onClick={() => { navigator.clipboard.writeText(result); showNotification('已复制'); }} className="flex-1 bg-blue-600 py-3 rounded-xl flex items-center justify-center gap-2">复制</button>
                    </div>
                </div>
            );
        }

        function Notification({ msg, type }) {
            if (!msg) return null;
            return <div className={`fixed top-4 left-1/2 -translate-x-1/2 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-full shadow-xl z-50`}>{msg}</div>;
        }

        function App() {
            const [view, setView] = useState('login');
            const [masterPassword, setMasterPassword] = useState('');
            const [vault, setVault] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [notification, setNotification] = useState(null);
            const [currentEntry, setCurrentEntry] = useState({ id: null, title: '', username: '', password: '', url: '', note: '' });
            const [searchQuery, setSearchQuery] = useState('');
            const [showPassword, setShowPassword] = useState({});
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);

            const showNotification = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };

            useEffect(() => {
                if (localStorage.getItem(DB_NAME)) setIsLoading(false);
                else { setView('setup'); setIsLoading(false); }
            }, []);

            const handleSetup = async () => {
                if (masterPassword.length < 4) return showNotification('密码太短', 'error');
                const encrypted = await encryptData([], masterPassword);
                localStorage.setItem(DB_NAME, encrypted);
                setVault([]); setView('dashboard'); showNotification('保险库已创建');
            };

            const handleLogin = async () => {
                setIsLoading(true);
                try {
                    const data = await decryptData(localStorage.getItem(DB_NAME), masterPassword);
                    setVault(data); setView('dashboard');
                } catch (e) { showNotification(e.message, 'error'); } 
                finally { setIsLoading(false); }
            };

            const saveVault = async (newVault) => {
                try {
                    const encrypted = await encryptData(newVault, masterPassword);
                    localStorage.setItem(DB_NAME, encrypted);
                    setVault(newVault); return true;
                } catch (e) { showNotification('保存失败', 'error'); return false; }
            };

            const handleAddOrUpdate = async () => {
                if (!currentEntry.title || !currentEntry.password) return showNotification('标题/密码必填', 'error');
                let newVault;
                if (currentEntry.id) {
                    newVault = vault.map(i => i.id === currentEntry.id ? { ...currentEntry, updatedAt: new Date().toISOString() } : i);
                } else {
                    newVault = [...vault, { ...currentEntry, id: Date.now().toString(), updatedAt: new Date().toISOString() }];
                }
                if (await saveVault(newVault)) {
                    showNotification('保存成功'); setView('dashboard'); setCurrentEntry({ id: null, title: '', username: '', password: '', url: '', note: '' });
                }
            };

            const handleDelete = async () => {
                if (!deleteConfirmId) return;
                const newVault = vault.filter(i => i.id !== deleteConfirmId);
                if (await saveVault(newVault)) { showNotification('已删除'); setDeleteConfirmId(null); }
            };
            
            const handleExport = () => {
                const blob = new Blob([localStorage.getItem(DB_NAME)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            };

            const handleImport = (e) => {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        await decryptData(ev.target.result, masterPassword);
                        localStorage.setItem(DB_NAME, ev.target.result);
                        await handleLogin(); showNotification('导入成功');
                    } catch(err) { showNotification('导入失败：密码错误或文件损坏', 'error'); }
                };
                if(e.target.files[0]) reader.readAsText(e.target.files[0]);
            };

            if (view === 'login' || view === 'setup') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="w-full max-w-md bg-slate-800 rounded-2xl p-8 border border-slate-700 shadow-xl">
                            <div className="flex justify-center mb-6"><div className="p-4 bg-blue-600/20 rounded-full text-blue-500"><Shield size={48} /></div></div>
                            <h1 className="text-2xl font-bold text-center mb-2">{view === 'login' ? '解锁保险库' : '创建新保险库'}</h1>
                            <input type="password" value={masterPassword} onChange={e => setMasterPassword(e.target.value)} placeholder="主密码" className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 mb-4" />
                            <button onClick={view === 'login' ? handleLogin : handleSetup} className="w-full bg-blue-600 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                {isLoading ? <RefreshCw className="animate-spin" /> : (view === 'login' ? <Unlock /> : <Save />)} {view === 'login' ? '解 锁' : '创 建'}
                            </button>
                            {view === 'login' && !showResetConfirm && <button onClick={() => setShowResetConfirm(true)} className="block w-full text-center mt-4 text-xs text-slate-500">重置保险库</button>}
                            {showResetConfirm && (
                                <div className="mt-4 bg-red-900/30 p-3 rounded text-center">
                                    <p className="text-xs text-red-300 mb-2">警告：重置将清除所有数据！</p>
                                    <div className="flex justify-center gap-2">
                                        <button onClick={() => { localStorage.removeItem(DB_NAME); window.location.reload(); }} className="px-3 py-1 bg-red-600 rounded text-xs">确认</button>
                                        <button onClick={() => setShowResetConfirm(false)} className="px-3 py-1 bg-slate-700 rounded text-xs">取消</button>
                                    </div>
                                </div>
                            )}
                        </div>
                        <Notification msg={notification?.msg} type={notification?.type} />
                    </div>
                );
            }

            return (
                <div className="max-w-3xl mx-auto p-4 pb-20">
                     <header className="flex justify-between items-center py-4 mb-4 border-b border-slate-800 sticky top-0 bg-slate-950 z-10">
                        <h1 className="text-lg font-bold flex items-center gap-2"><Shield className="text-blue-500" size={20}/> 密码管家</h1>
                        <div className="flex gap-2">
                            <button onClick={() => setView('ai-tools')} className="p-2 bg-slate-800 rounded-full"><Sparkles className="text-yellow-400" size={20}/></button>
                            <button onClick={() => setView('settings')} className="p-2 bg-slate-800 rounded-full"><Settings className="text-slate-400" size={20}/></button>
                            <button onClick={() => setView('login')} className="p-2 bg-slate-800 rounded-full"><Lock className="text-slate-400" size={20}/></button>
                        </div>
                    </header>
                    
                    {view === 'dashboard' && (
                        <>
                            <div className="relative mb-6">
                                <span className="absolute left-3 top-3.5 text-slate-500"><Search size={20}/></span>
                                <input className="w-full bg-slate-900 border border-slate-800 rounded-xl py-3 pl-10" placeholder="搜索..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                            </div>
                            <div className="space-y-3">
                                {vault.filter(e => e.title.includes(searchQuery)).map(entry => (
                                    <div key={entry.id} className="bg-slate-900 border border-slate-800 rounded-xl p-4">
                                        <div className="flex justify-between mb-2">
                                            <div><h3 className="font-bold">{entry.title}</h3><p className="text-sm text-slate-400">{entry.username}</p></div>
                                            <div className="flex gap-1">
                                                <button onClick={() => { setCurrentEntry(entry); setView('edit'); }} className="p-2 text-slate-400"><Settings size={16} /></button>
                                                <button onClick={() => setDeleteConfirmId(entry.id)} className="p-2 text-red-400"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                        <div className="bg-slate-950 p-3 rounded flex justify-between border border-slate-800">
                                            <div className="font-mono text-sm overflow-hidden whitespace-nowrap mr-2">{showPassword[entry.id] ? entry.password : '••••••••'}</div>
                                            <div className="flex gap-2">
                                                <button onClick={() => setShowPassword(p => ({...p, [entry.id]: !p[entry.id]}))} className="text-slate-500"><Eye size={16} /></button>
                                                <button onClick={() => { navigator.clipboard.writeText(entry.password); showNotification('已复制'); }} className="text-slate-500"><Copy size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => { setCurrentEntry({}); setView('add'); }} className="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center shadow-lg"><Plus size={32}/></button>
                        </>
                    )}

                    {(view === 'add' || view === 'edit') && (
                        <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                            <div className="flex justify-between mb-6"><h2 className="text-xl font-bold">{view === 'add' ? '添加' : '编辑'}</h2><button onClick={() => setView('dashboard')}><X /></button></div>
                            <div className="space-y-4">
                                <input className="w-full bg-slate-950 border border-slate-700 rounded p-3" value={currentEntry.title || ''} onChange={e => setCurrentEntry({...currentEntry, title: e.target.value})} placeholder="标题" />
                                <input className="w-full bg-slate-950 border border-slate-700 rounded p-3" value={currentEntry.username || ''} onChange={e => setCurrentEntry({...currentEntry, username: e.target.value})} placeholder="用户名" />
                                <div className="flex gap-2">
                                    <input className="w-full bg-slate-950 border border-slate-700 rounded p-3 font-mono" value={currentEntry.password || ''} onChange={e => setCurrentEntry({...currentEntry, password: e.target.value})} placeholder="密码" />
                                    <button onClick={() => setCurrentEntry({...currentEntry, password: Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-8) })} className="px-3 bg-slate-800 border border-slate-700 rounded">生成</button>
                                </div>
                                <textarea className="w-full bg-slate-950 border border-slate-700 rounded p-3 h-20" value={currentEntry.note || ''} onChange={e => setCurrentEntry({...currentEntry, note: e.target.value})} placeholder="备注" />
                                <button onClick={handleAddOrUpdate} className="w-full bg-blue-600 py-3 rounded font-bold mt-4 flex justify-center gap-2"><Save /> 保存</button>
                            </div>
                        </div>
                    )}

                    {view === 'ai-tools' && (
                        <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 h-[80vh]">
                            <div className="flex justify-between mb-4"><h2 className="text-xl font-bold">AI 实验室</h2><button onClick={() => setView('dashboard')}><X /></button></div>
                            <AITools showNotification={showNotification} />
                        </div>
                    )}

                    {view === 'settings' && (
                        <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                            <div className="flex justify-between mb-6"><h2 className="text-xl font-bold">设置</h2><button onClick={() => setView('dashboard')}><X /></button></div>
                            <div className="grid gap-4">
                                <button onClick={handleExport} className="p-4 bg-slate-800 rounded border border-slate-700 flex gap-3 items-center"><Download className="text-green-400" /> 导出备份</button>
                                <label className="p-4 bg-slate-800 rounded border border-slate-700 flex gap-3 items-center cursor-pointer"><Upload className="text-yellow-400" /> 导入备份 <input type="file" onChange={handleImport} hidden accept=".json" /></label>
                                <button onClick={() => { if(confirm('清空所有数据？')) { localStorage.removeItem(DB_NAME); location.reload(); }}} className="p-4 bg-red-900/20 text-red-400 rounded border border-red-900/50 text-left">重置/清除数据</button>
                            </div>
                        </div>
                    )}

                    {deleteConfirmId && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-700">
                                <h3 className="text-xl font-bold text-red-400 mb-2 flex items-center gap-2"><AlertTriangle /> 确认删除？</h3>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-2 bg-slate-700 rounded">取消</button>
                                    <button onClick={handleDelete} className="flex-1 py-2 bg-red-600 rounded">删除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <Notification msg={notification?.msg} type={notification?.type} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>